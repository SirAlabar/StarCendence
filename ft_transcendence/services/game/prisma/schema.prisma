// == GAME SERVICE == //

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GAME MODELS
// ============================================================================

model Game {
  id            String        @id @default(cuid())
  type          String        @default("PONG")        // "PONG" | "RACER"
  mode          String        @default("MULTIPLAYER_2P") // "MULTIPLAYER_2P" etc.
  status        String        @default("WAITING")     // "WAITING" | "READY" | "PLAYING"...

  // Game configuration
  maxPlayers    Int           @default(2)
  minPlayers    Int           @default(2)
  maxScore      Int?
  lapCount      Int?

  // Timestamps
  createdAt     DateTime      @default(now())
  startedAt     DateTime?
  endedAt       DateTime?

  // Relations
  players       GamePlayer[]
  matches       Match[]

  // Tournament relation (optional)
  tournamentId  String?
  tournament    Tournament?   @relation(fields: [tournamentId], references: [id])

  @@index([status])
  @@index([type])
  @@index([tournamentId])
}

model GamePlayer {
  id            String        @id @default(cuid())
  gameId        String
  game          Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)

  userId        String
  playerRole    String        @default("PLAYER1")  // "PLAYER1", "PLAYER2", etc.

  // Player state
  isReady       Boolean       @default(false)
  isConnected   Boolean       @default(true)
  score         Int           @default(0)

  // Racer specific
  position      Int?
  lapTime       Float?

  // Timestamps
  joinedAt      DateTime      @default(now())
  leftAt        DateTime?

  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
}

// ============================================================================
// MATCH HISTORY
// ============================================================================

model Match {
  id            String        @id @default(cuid())
  gameId        String
  game          Game          @relation(fields: [gameId], references: [id])

  type          String        @default("PONG")
  mode          String        @default("MULTIPLAYER_2P")

  // Match result
  winnerId      String?
  duration      Int

  // Final scores/positions
  results       MatchResult[]

  // Match stats
  totalPoints   Int?
  fastestLap    Float?

  // Timestamps
  playedAt      DateTime      @default(now())

  @@index([winnerId])
  @@index([type])
  @@index([playedAt])
}

model MatchResult {
  id            String        @id @default(cuid())
  matchId       String
  match         Match         @relation(fields: [matchId], references: [id], onDelete: Cascade)

  userId        String
  score         Int

  // Additional stats
  accuracy      Float?
  topSpeed      Float?

  @@unique([matchId, userId])
  @@index([userId])
  @@index([matchId])
}

// ============================================================================
// PLAYER STATISTICS
// ============================================================================

model PlayerStats {
  id                String    @id @default(cuid())
  userId            String    @unique

  // Overall stats
  gamesPlayed       Int       @default(0)
  gamesWon          Int       @default(0)
  gamesLost         Int       @default(0)

  // Pong stats
  pongGamesPlayed   Int       @default(0)
  pongGamesWon      Int       @default(0)
  pongPointsScored  Int       @default(0)
  pongBestScore     Int       @default(0)

  // Racer stats
  racerGamesPlayed  Int       @default(0)
  racerGamesWon     Int       @default(0)
  racerBestLapTime  Float?
  racerBestPosition Int       @default(999)

  // ELO ratings
  pongElo           Int       @default(1000)
  racerElo          Int       @default(1000)

  // Streaks
  currentWinStreak  Int       @default(0)
  longestWinStreak  Int       @default(0)

  // Timestamps
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([pongElo])
  @@index([racerElo])
}

// ============================================================================
// TOURNAMENTS
// ============================================================================

model Tournament {
  id              String            @id @default(cuid())
  name            String
  type            String            @default("PONG")
  status          String            @default("PENDING") // "PENDING", "IN_PROGRESS", "FINISHED"...

  // Configuration
  maxParticipants Int               @default(8)
  currentRound    Int               @default(0)
  totalRounds     Int

  // Timestamps
  createdAt       DateTime          @default(now())
  startedAt       DateTime?
  endedAt         DateTime?

  // Relations
  participants    TournamentPlayer[]
  games           Game[]

  // Winner
  winnerId        String?

  @@index([status])
  @@index([type])
}

model TournamentPlayer {
  id              String      @id @default(cuid())
  tournamentId    String
  tournament      Tournament  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  userId          String
  seed            Int
  currentRound    Int         @default(0)
  isEliminated    Boolean     @default(false)

  joinedAt        DateTime    @default(now())

  @@unique([tournamentId, userId])
  @@index([tournamentId])
  @@index([userId])
}
