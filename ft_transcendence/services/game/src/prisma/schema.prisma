// Game Service Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GAME MODELS
// ============================================================================

model Game {
  id            String        @id @default(cuid())
  type          GameType      // pong or racer
  mode          GameMode      // multiplayer_2p, multiplayer_3p, multiplayer_4p, tournament
  status        GameStatus    @default(WAITING)
  
  // Game configuration
  maxPlayers    Int           @default(2)
  minPlayers    Int           @default(2)
  maxScore      Int?          // For Pong
  lapCount      Int?          // For Racer
  
  // Timestamps
  createdAt     DateTime      @default(now())
  startedAt     DateTime?
  endedAt       DateTime?
  
  // Relations
  players       GamePlayer[]
  matches       Match[]
  
  // Tournament relation (optional)
  tournamentId  String?
  tournament    Tournament?   @relation(fields: [tournamentId], references: [id])
  
  @@index([status])
  @@index([type])
  @@index([tournamentId])
}

model GamePlayer {
  id            String        @id @default(cuid())
  gameId        String
  game          Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  userId        String
  playerRole    PlayerRole    // player1, player2, player3, player4, spectator
  
  // Player state
  isReady       Boolean       @default(false)
  isConnected   Boolean       @default(true)
  score         Int           @default(0)
  
  // Racer specific
  position      Int?          // Final position in race
  lapTime       Float?        // Best lap time
  
  // Timestamps
  joinedAt      DateTime      @default(now())
  leftAt        DateTime?
  
  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
}

// ============================================================================
// MATCH HISTORY
// ============================================================================

model Match {
  id            String        @id @default(cuid())
  gameId        String
  game          Game          @relation(fields: [gameId], references: [id])
  
  type          GameType
  mode          GameMode
  
  // Match result
  winnerId      String?
  duration      Int           // Duration in seconds
  
  // Final scores/positions
  results       MatchResult[]
  
  // Match stats
  totalPoints   Int?          // Pong: total points scored
  fastestLap    Float?        // Racer: fastest lap time
  
  // Timestamps
  playedAt      DateTime      @default(now())
  
  @@index([winnerId])
  @@index([type])
  @@index([playedAt])
}

model MatchResult {
  id            String        @id @default(cuid())
  matchId       String
  match         Match         @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  userId        String
  score         Int           // Pong: points scored / Racer: final position
  
  // Additional stats
  accuracy      Float?        // Pong: paddle hit accuracy
  topSpeed      Float?        // Racer: maximum speed reached
  
  @@unique([matchId, userId])
  @@index([userId])
  @@index([matchId])
}

// ============================================================================
// PLAYER STATISTICS
// ============================================================================

model PlayerStats {
  id                String    @id @default(cuid())
  userId            String    @unique
  
  // Overall stats
  gamesPlayed       Int       @default(0)
  gamesWon          Int       @default(0)
  gamesLost         Int       @default(0)
  
  // Pong stats
  pongGamesPlayed   Int       @default(0)
  pongGamesWon      Int       @default(0)
  pongPointsScored  Int       @default(0)
  pongBestScore     Int       @default(0)
  
  // Racer stats
  racerGamesPlayed  Int       @default(0)
  racerGamesWon     Int       @default(0)
  racerBestLapTime  Float?
  racerBestPosition Int       @default(999)
  
  // ELO ratings
  pongElo           Int       @default(1000)
  racerElo          Int       @default(1000)
  
  // Streaks
  currentWinStreak  Int       @default(0)
  longestWinStreak  Int       @default(0)
  
  // Timestamps
  updatedAt         DateTime  @updatedAt
  
  @@index([userId])
  @@index([pongElo])
  @@index([racerElo])
}

// ============================================================================
// TOURNAMENTS
// ============================================================================

model Tournament {
  id              String            @id @default(cuid())
  name            String
  type            GameType
  
  status          TournamentStatus  @default(PENDING)
  
  // Configuration
  maxParticipants Int               @default(8)
  currentRound    Int               @default(0)
  totalRounds     Int
  
  // Timestamps
  createdAt       DateTime          @default(now())
  startedAt       DateTime?
  endedAt         DateTime?
  
  // Relations
  participants    TournamentPlayer[]
  games           Game[]
  
  // Winner
  winnerId        String?
  
  @@index([status])
  @@index([type])
}

model TournamentPlayer {
  id              String      @id @default(cuid())
  tournamentId    String
  tournament      Tournament  @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  userId          String
  seed            Int         // Seeding position
  currentRound    Int         @default(0)
  isEliminated    Boolean     @default(false)
  
  joinedAt        DateTime    @default(now())
  
  @@unique([tournamentId, userId])
  @@index([tournamentId])
  @@index([userId])
}

// ============================================================================
// ENUMS
// ============================================================================

enum GameType {
  PONG
  RACER
}

enum GameMode {
  MULTIPLAYER_2P
  MULTIPLAYER_3P
  MULTIPLAYER_4P
  TOURNAMENT
}

enum GameStatus {
  WAITING       // Waiting for players
  READY         // All players ready
  STARTING      // Countdown
  PLAYING       // Game in progress
  PAUSED        // Game paused
  FINISHED      // Game completed
  CANCELLED     // Game cancelled
}

enum PlayerRole {
  PLAYER1
  PLAYER2
  PLAYER3
  PLAYER4
  SPECTATOR
}

enum TournamentStatus {
  PENDING       // Not started yet
  REGISTRATION  // Open for registration
  IN_PROGRESS   // Tournament ongoing
  FINISHED      // Tournament completed
  CANCELLED     // Tournament cancelled
}
