// == USER SERVICE == //
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:/app/data/user.db"
}

// Core user model
model UserProfile {
  id        String   @id // same as AuthUser id
  email     String   @unique
  username  String   @unique
  bio       String?
  avatarUrl String?
  status    String   @default("OFFLINE")
  twoFactorEnabled  Boolean  @default(false)
  oauthEnabled Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  friendRequestSent    Friendship[] @relation("FriendRequestsSent")
  friendRequestReceived Friendship[] @relation("FriendRequestsReceived")

  matchHistoryAsPlayer1 MatchHistory[] @relation("Player1")
  matchHistoryAsPlayer2 MatchHistory[] @relation("Player2")

  tournamentMatchAsPlayer1 TournamentMatch[] @relation("TournamentPlayer1")
  tournamentMatchAsPlayer2 TournamentMatch[] @relation("TournamentPlayer2")

  tournamentsWon Tournament[] @relation("TournamentWinner")
  tournamentParticipant TournamentParticipant[]

  tournamentWins Int @default(0)
  tournamentParticipations Int @default(0)

  totalGames Int @default(0)
  totalWins Int @default(0)
  totalLosses Int @default(0)
  totalDraws Int @default(0)
  totalPongWins Int @default(0)
  totalPongLoss Int @default(0)
  totalRacerWins Int @default(0)
  totalRacerLoss Int @default(0)
  totalWinPercent Float? 

  rank Int @default(1000)
  points Int @default(0)

  @@index([points(sort: Desc)])
  @@map("users")
}

// Friendship model to represent friend requests and relationships
model Friendship {
  id         Int      @id @default(autoincrement())
  sender  UserProfile @relation("FriendRequestsSent", fields: [senderId], references: [id])
  senderId String
  recipient  UserProfile @relation("FriendRequestsReceived", fields: [recipientId], references: [id])
  recipientId String

  status      String  @default("PENDING")
  createdAt  DateTime @default(now())

  @@unique([senderId, recipientId])
  @@map("friendships")
}

// Match history model to log game results between users
model MatchHistory {
  id         Int      @id @default(autoincrement())
  player1  UserProfile @relation("Player1", fields: [player1Id], references: [id])
  player1Id String
  player2  UserProfile @relation("Player2", fields: [player2Id], references: [id])
  player2Id String

  player1Score Int
  player2Score Int

  playedAt   DateTime @default(now())
  result     String

  @@map("match_history")
}

// Tournament model to manage tournaments | a tournament can have many participants
model Tournament {
  id          Int      @id @default(autoincrement())
  gameServiceId String?
  createdAt   DateTime?

  winnerId   String?
  winner     UserProfile? @relation("TournamentWinner", fields: [winnerId], references: [id])

  participants TournamentParticipant[]
  rounds      Round[]

  @@map("tournament")
}

// Join table for many-to-many relationship between Tournaments and Users
model TournamentParticipant {
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  tournamentId Int

  user         UserProfile @relation(fields: [userId], references: [id])
  userId       String

  placement    Int
  joinedAt     DateTime?

  @@unique([tournamentId, userId])
  @@map("tournament_participants")
}

model Round {
  id          Int      @id @default(autoincrement())
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  tournamentId Int

  roundNumber Int
  playedAt   DateTime?

  matches     TournamentMatch[]

  @@unique([tournamentId, roundNumber])
  @@map("tournament_rounds")
}

model TournamentMatch {
  id          Int      @id @default(autoincrement())
  round       Round    @relation(fields: [roundId], references: [id])
  roundId     Int

  player1     UserProfile @relation("TournamentPlayer1", fields: [player1Id], references: [id])
  player1Id   String
  player2     UserProfile @relation("TournamentPlayer2", fields: [player2Id], references: [id])
  player2Id   String

  player1Score Int
  player2Score Int

  playedAt    DateTime?
  result      String

  @@map("tournament_matches")
}
