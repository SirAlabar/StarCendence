// == USER SERVICE == //
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:/app/data/user.db"
}

// Core user model
model UserProfile {
  id        String   @id // same as AuthUser id
  email     String   @unique
  username  String   @unique
  bio       String?
  avatarUrl String?
  status    String   @default("OFFLINE")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  friendRequestSent    Friendship[] @relation("FriendRequestsSent")
  friendRequestReceived Friendship[] @relation("FriendRequestsReceived")

  matchHistoriesAsPlayer1 MatchHistory[] @relation("Player1")
  matchHistoriesAsPlayer2 MatchHistory[] @relation("Player2")

  tournaments TournamentParticipant[]

  @@map("users")
}

// Friendship model to represent friend requests and relationships
model Friendship {
  id         Int      @id @default(autoincrement())
  sender  UserProfile @relation("FriendRequestsSent", fields: [senderId], references: [id])
  senderId String
  recipient  UserProfile @relation("FriendRequestsReceived", fields: [recipientId], references: [id])
  recipientId String
  status      String  @default("PENDING")
  createdAt  DateTime @default(now())

  @@unique([senderId, recipientId])
  @@map("friendships")
}

// Match history model to log game results between users
model MatchHistory {
  id         Int      @id @default(autoincrement())
  player1  UserProfile @relation("Player1", fields: [player1Id], references: [id])
  player1Id String
  player2  UserProfile @relation("Player2", fields: [player2Id], references: [id])
  player2Id String
  player1Score Int
  player2Score Int
  playedAt   DateTime @default(now())
  result     String


  @@map("match_history")
}

// Tournament model to manage tournaments | a tournament can have many participants
model Tournament {
  id          Int      @id @default(autoincrement())
  
  
  createdAt   DateTime @default(now())
  participants TournamentParticipant[]

  @@map("tournaments")
}

// Join table for many-to-many relationship between Tournaments and Users
model TournamentParticipant {
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  tournamentId Int
  user         UserProfile @relation(fields: [userId], references: [id])
  userId       String
  joinedAt     DateTime   @default(now())

  @@unique([tournamentId, userId])
  @@map("tournament_participants")
}
